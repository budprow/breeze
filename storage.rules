rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // This rule applies to files inside a specific restaurant's 'documents' folder.
    match /documents/{restaurantId}/{allPaths=**} {

      // This function checks the Firestore database to see if the currently
      // logged-in user belongs to the restaurant they are trying to access.
      function isRestaurantMember() {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.restaurantId == restaurantId;
      }

      // Allow users to read and write (upload, delete) files if they are authenticated
      // AND they are a member of the restaurant.
      allow read, write: if request.auth != null && isRestaurantMember();
    }
  }
}